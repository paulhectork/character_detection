# CHARACTER DETECTION

A character detection pipeline based on [DTLR](https://github.com/raphael-baena/DTLR). Most of the work is done in the submodules.

---

## STRUCTURE

```
root/
 |_data                       # input files go here
 |_data_line_prediction       # output from step 1
 |_data_character_detection   # output from step 2
 |_DTLR                       # step 2: character detection
 |_LinePredictor              # step 1: line detection
```

---

## SETUP 

### Clone

```bash
git clone git@github.com:paulhectork/character_detection.git
cd submodule
git submodule init && git submodule update
```

### Setup

1. Setup CUDA

	```bash
	nvcc --version  # displays cuda version currently in use
	nvidia-smi      # on the top-right, displays higher version installed on the system

	# make sure nvcc version matches selected CUDA_HOME
	export CUDA_HOME=<path/to/cuda>   # often `/usr/local/cuda`a
	export PATH=$CUDA_HOME/bin:$PATH
	export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
	```
2. Setup python venv. `requirements.txt` is auto-generated by combining the requirements file of both submodules using [fuser](https://github.com/paulhectork/fuser)
	```bash
	python3 -m venv venv
	source venv/bin/activate
	pip install wheel
	pip install -r requirements.txt
	```
3. Compile CUDA operators. Tests could output an outofmemory error.
	```bash
	cd LinePredictor/models/
	python ./dino/ops/setup.py build install
	python ./dino/ops/test.py
	
	# ACTUALLY it's useless to build the DTLR cuda operators since they were aldready built in LinePredictor
	# cd  DTLR/models/
	# python models/dino/ops/setup.py build install
	# python models/dino/ops/test.py
	```

--- 

## USE

Use the scripted pipeline:

```bash
bash pipeline.sh [-s|-v] 
```

Or do it manually:

```bash
source venv/bin/activate

# step 1: line dedection
python LinePredictor/pipeline_inference.py -i ./data -o ./data_line_prediction/ [-s]

# step 2: character detection
python DTLR/pipeline_inference.py -i ./data -b ./data_line_prediction -o ./data_character_detection
```

